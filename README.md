![version](https://img.shields.io/badge/version-20%2B-E23089)
![platform](https://img.shields.io/static/v1?label=platform&message=mac-intel%20|%20mac-arm%20|%20win-64&color=blue)
[![license](https://img.shields.io/github/license/miyako/mermaid)](LICENSE)
![downloads](https://img.shields.io/github/downloads/miyako/mermaid/total)

# mermaid
Tool to convert mermaid markdown to SVG (namespace: `mermaid`)

## usage

There are `3` ways to use `mermaid`; atomic, asynchronous, or server.

* **atomic**: A new instance of `headless_chrome` is created for each request. You can batch process a collection of markdown code in one call.
 
* **asynchronous**: Same as atomic but a callback function is invoked on completion.

* **server**: An HTTP server is started which keeps a mutex-guarded instance of `headless_chrome`. Payload to each request should be a single markdown. Supports rendering in PNG format.

### atomic

```4d
var $mermaid : cs.mermaid.mermaid
$mermaid:=cs.mermaid.mermaid.new()
var $tasks : Collection
$tasks:=[]
var $file : Variant

$file:="graph TD\n    A[Start] --> B{Is it working?}\n    B -- Yes --> C[Great!]\n    B -- No --> D[Check the code]\n    D --> B\n    C --> E[End]"
$tasks.push({file: $file; data: Folder(fk desktop folder).file("2.svg")})

$results:=$mermaid.render($tasks)
```

### asynchronous

```4d
var $mermaid : cs.mermaid.mermaid
$mermaid:=cs.mermaid.mermaid.new()
var $tasks : Collection
$tasks:=[]
var $file : Variant
	
$file:="graph TD\n    A[Start] --> B{Is it working?}\n    B -- Yes --> C[Great!]\n    B -- No --> D[Check the code]\n    D --> B\n    C --> E[End]"
$tasks.push({file: $file; data: Folder(fk desktop folder).file("2.svg")})

$mermaid.render($tasks; Formula(onResponse))
```

The callback formula should have the following signature:

```4d
#DECLARE($worker : 4D.SystemWorker; $params : Object)

var $text : Text
$text:=$worker.response
```

> [!TIP]
> whatever value you pass in `data` is returned in `context`.

### server

```4d
var $mermaid : cs.mermaid.server
$mermaid:=cs.mermaid.server.new()
$mermaid.start(port: 8282)
```

`POST` a payload to `/render`.  
If successful, `image/svg+xml` or `image/svg` is returned.  
If unsuccessful, error message in `application/json` is returned.

> [!WARNING]
> The SVG generated by `mermaid.min.js` includes `<foreignObject>` elements of XHTML. 4D can't process such images.

```4d
Function render()
	var $body : Object
	$body:={format: "png"; scale: 2}
	$body.text:=OBJECT Get name(Object with focus)="Markdown" ? Get edited text : Form.Markdown
		
	This.body:=$body
		
	var $request : 4D.HTTPRequest
	$request:=4D.HTTPRequest.new("http://127.0.0.1:8282/render"; This)

Function onResponse($request : 4D.HTTPRequest; $event : Object)
	
	If (Form#Null)
		If ($request.response.status=200)
			var $png : Picture
			BLOB TO PICTURE($request.response.body; $png; ".png")
			Form.Diagram:=$png
			This.Message:="Success!"
		Else 
			This.Message:="Error! "+$request.response.body.message
		End if 
	End if 
```
